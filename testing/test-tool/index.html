<!DOCTYPE html>
<html>

    <head>
        <meta
            http-equiv = 'Content-Type'
            content = 'text/html; charset = utf-8'>

        <title>Testing Tool for Graphics Renderers</title>
        <script type = 'text/javascript'
            src = 'https://d3js.org/d3.v3.min.js'></script>
        <script type = 'text/javascript'
            src = 'https://cdn.rawgit.com/RhoInc/Webcharts/master/build/webcharts.js'></script>

        <link type = 'text/css'
            rel = 'stylesheet'
            href = 'https://cdn.rawgit.com/RhoInc/web-codebook/a1756e54e107dab5f2cf66625eb44b323179beba/css/webcodebook.css'>
        <link type = 'text/css'
                rel = 'stylesheet'
                href = 'test-tool.css'>

    </head>

    <body>
      <div id = 'title'>Testing Tool for Graphics Renderers</div>
      <div id="controls"></div>
      <div id="chart"></div>
      <div id="data"></div>
    </body>

    <script>
      var settings = {
        rootURL:"https://cdn.rawgit.com/RhoInc",
        renderers:[
          {name:"web-codebook",main:"webcodebook",sub:"createChart",css:""},
          {name:"webcharts",main:"webcharts",sub:"createChart",css:""},
          {name:"aeexplorer",main:"aeTable",sub:"createChart",css:""},
          {name:"aetimelines",main:"aeTimelines",sub:null,css:""},
          {name:"safety-histogram",main:"safetyHistogram",sub:null,css:""},
          {name:"safety-outlier-explorer",main:"safetyOutlierExplorer",sub:null,css:""},
          {name:"safety-results-over-time",main:"safetyResultsOverTime",sub:null,css:""},
          {name:"safety-shift-plot",main:"safetyShiftPlot",sub:null,css:""}
        ],
        dataURL:"https://rhoinc.github.io/viz-library/examples/0000-sample-data/",
        dataFiles:[
          "safetyData-queries/ADAE.csv",
          "safetyData-queries/ADBDS.csv",
          "safetyData/ADAE.csv",
          "safetyData/ADBDS.csv",
          "safetyData/AE.csv",
          "safetyData/DM.csv",
          "safetyData/LB.csv"
        ]

      }
      //Make the controls
      var controls = d3.select("#controls")

      //submit
      var submitButton = controls.append("button").attr("class","submit").text("Render Chart")

      //Choose a renderer
      var rendererWrap = controls.append("div").attr("class","control-wrap")
      rendererWrap.append("span").text("Renderer:")
      var rendererSelect = rendererWrap.append("select")
      rendererSelect.selectAll("option")
      .data(settings.renderers)
      .enter()
      .append("option")
      .text(function(d){return d.name})

      //Choose a version
      rendererWrap.append("span").text("  Version:")
      var versionSelect = rendererWrap.append("input")
      versionSelect.node().value="master"

      //Choose a data file
      var datafileWrap = controls.append("div").attr("class","control-wrap")

      datafileWrap.append("span").text("Data:")
      var dataFileSelect = datafileWrap.append("select")
      dataFileSelect.selectAll("option")
      .data(settings.dataFiles)
      .enter()
      .append("option")
      .text(function(d){return d})


      //Edit the settings
      var settingsWrap = controls.append("div").attr("class","control-wrap")
      settingsWrap.append("span").text("Settings:")
      settingsWrap.append("br")
      var settingsInput = settingsWrap.append("textarea")
      .attr("rows",10)
      .attr("cols",50)
      .text("{}")



      //event listeners
      //when a renderer is choosen
        //populate the versions
        //populate the default settings

      //when a data file is choosen
        //update the preview

      //when the settings change
        //check that they are valid json

      //on submit

      //load the right version of the renderer asynchronously
      function loadRenderer(src, callback) {
        var s,
            r,
            t;
        r = false;
        s = document.createElement('script');
        s.type = 'text/javascript';
        s.src = src;
        s.onload = s.onreadystatechange = function() {
          if ( !r && (!this.readyState || this.readyState == 'complete') )
          {
            r = true;
            callback();
          }
        };
        t = document.getElementsByTagName('script')[0];
        t.parentNode.insertBefore(s, t);
      }

      submitButton.on("click",function(){
        var rendererObj = rendererSelect.selectAll("option:checked").data()[0];
        var version = versionSelect.node().value;
        var rendererPath = settings.rootURL+"/"+rendererObj.name+"/"+version+"/build/"+rendererObj.main+".js";

        function renderChart() {
            console.clear();
            console.log('Renderer: ' + rendererObj.name);
            console.log('  Version: ' + version);
            console.log('  URL: ' + rendererPath);

            d3.select("#chart").selectAll("*").remove()

          //render the new chart with the current settings
            var dataFile = dataFileSelect.node().value
            var dataFilePath = settings.dataURL + dataFile
            var chartSettings = JSON.parse(settingsInput.node().value);
            console.log('  Settings: ' + settingsInput.node().value.replace(/\t/g, ' ').replace(/\n| +(?= )/g, ''));
            console.log('  Data: ' + dataFile);
            d3.csv(dataFilePath, function(data) {
              if(rendererObj.sub){
                var myChart = window[rendererObj.main][rendererObj.sub]("#chart",chartSettings);
              }else{
                var myChart = window[rendererObj.main]("#chart",chartSettings);
              }

              myChart.init(data)
            });
        }

        loadRenderer(rendererPath, renderChart)
      })
    </script>
</html>
